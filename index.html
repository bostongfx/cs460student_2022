<html>
	<head>
		<title>Final Project!</title>
		<link rel="stylesheet" href="./presentation.css" />

		<!-- Import Map Polyfill -->
		<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
		<script type="importmap">
			{
				"imports": {
					"three": "https://threejs.org/build/three.module.js",
					"three/addons/": "https://threejs.org/examples/jsm/"
				}
			}
		</script>

		<script type="module">
			import * as THREE from 'three';
      import { GUI } from 'https://unpkg.com/dat.gui@0.7.7/build/dat.gui.module.js';
      import { TrackballControls } from 'https://threejs.org/examples/jsm/controls/TrackballControls.js';
      import { OBJLoader } from 'https://threejs.org/examples/jsm/loaders/OBJLoader.js';
			import { wireframe } from './final/wireframe.js';
			import text from './final/presentation_text.js';

			var scene, camera, renderer, ambientLight, light, pointLight, controls, floor, effect, vShader, fShader, controller, objects, palm, object;
			var slide = 0;

			window.onload = function() {
				/*
				updateText();
				document.body.addEventListener('keydown', (e) => {
					if (e.keyCode === 39) {
						slide++
						if (slide > text.length) slide = text.length-1;
						updateText();
					} else if (e.keyCode === 37) {
						--slide
						if (slide < 0) slide = 0;
						updateText();
					}
				});
				*/

				objects = [];

			scene = new THREE.Scene();

			var fov = 60;
			var ratio = window.innerWidth / window.innerHeight;
			var zNear = 1;
			var zFar = 10000;

			camera = new THREE.PerspectiveCamera(fov, ratio, zNear, zFar);
			camera.position.set(0,0,50);

			renderer = new THREE.WebGLRenderer({alpha:true, antialias: true});
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			// LIGHTS
			ambientLight = new THREE.AmbientLight();
			scene.add( ambientLight );

			light = new THREE.DirectionalLight('black', 5.0);
			light.position.set(10, 100, 10);
			scene.add(light);

			pointLight = new THREE.PointLight(0xff0000, 1, 100);
			pointLight.position.set(0, 20, 0);
			scene.add(pointLight);

			// LINE CONTROLLER
			controller = {
				line: {
					width: 1.5,
				}
			}

			// PALM TREE
			const loader = new OBJLoader();
			loader.load(
				'final/palm_tree.obj',
				function(obj) {
					var object = obj.children[0].geometry;
					var result = retroRender(object, 1);
					result.position.y = 1;
					result.rotateY(90);
				},
				function (xhr) {
					console.log((xhr.loaded/xhr.total * 100) + '% loaded');
				},
				function (err) {
					console.log("An error occurred when loading an OBJ file:", err);
				}
			);
			loader.load(
				'final/synth_ground.obj',
				function(obj) {
					var object = obj.children[0].geometry;
					var result = retroRender(object, 1);
					result.scale.x = 10;
					result.scale.z = 10;
				},
				function (xhr) {
					console.log((xhr.loaded/xhr.total * 100) + '% loaded');
				},
				function (err) {
					console.log("An error occurred when loading an OBJ file:", err);
				}
			);
/*
			var boxGeom = new THREE.BoxGeometry(15, 15, 15);
			var box = retroRender(boxGeom, controller.line.width);
			box.position.y = 30;
			objects.push(box);

			var torus = new THREE.TorusKnotGeometry(10, 3, 40, 10);
			var knot = retroRender(torus, controller.line.width);
			objects.push(knot);

			var octaGeom = new THREE.OctahedronGeometry(10);
			var octa = retroRender(octaGeom, controller.line.width);
			octa.position.x = 35;
			objects.push(octa);

			var sunGeom = new THREE.SphereGeometry(10, 3, 3);
			var sphere = retroRender(sunGeom, controller.line.width);
			sphere.position.z = -5;
			sphere.position.x = -35;
			objects.push(sphere);
			*/

			controls = new TrackballControls( camera, renderer.domElement );

			animate();
		}

		function retroRender(geometry, lineWidth) {
			// SHADER
			wireframe.setupAttributes(THREE, geometry);

			var material = new THREE.ShaderMaterial({
				vertexShader: wireframe.VertexShader,
				fragmentShader: wireframe.FragmentShader,
				uniforms: {
						'thickness': {value: lineWidth},
						'glow': {value: [0.9, 0.0, 0.9]},
						'inner': {value: [1.0, 1.0, 1.0]},
				},
				alphaToCoverage: true,
				side: THREE.DoubleSide,
			});
			material.extensions.derivatives = true;
			var solid = new THREE.Mesh(geometry, material);
			scene.add(solid);
			return solid;
		}

		function animate() {
			objects.forEach((item) => {
				item.rotateX(Math.PI/360);
				item.rotateY(Math.PI/360);
				item.rotateZ(Math.PI/360);
			});

			requestAnimationFrame( animate );

			controls.update();

			// and here...
			//effect.render(scene, camera);
			renderer.render(scene, camera);
		}

		function updateText() {
			if (slide >= text.length) return;
			var target = document.getElementById("content-goes-here");
			target.innerHTML = "";
			var header = document.createElement("h2")
			header.innerText = text[slide].header;
			target.appendChild(header);

			var list = document.createElement("ul");
			text[slide].bullets.forEach(item => {
				var li = document.createElement("li");
				li.innerText = item;
				list.appendChild(li);
			});
			target.appendChild(list);
		}
		</script>
	</head>
	<body style="background-color: black; margin: 0; padding:0; overflow: hidden">
		<header class="textbox">
			<h1>1980s Retro Futurism</h1>
		</header>
		<main class="textbox" style="display: none;">
			<article id="content-goes-here"></article>
		</main>
		<footer class="textbox">
			<span>Created by Emily Gagne for CS460, Fall 2022</span> ||
			<a href="./contents.html">View Other Projects</a> ||
			<a href="https://threejs.org/examples/#webgl_materials_wireframe">Wireframe Example</a>
		</footer>
	</body>
</html>